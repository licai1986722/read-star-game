<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ—è¯»å°çº¢æ˜Ÿï¼ˆè‡ªåŠ¨åˆ¤å®šç‰ˆï¼‰</title>
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue",Arial,"Noto Sans CJK SC",sans-serif;background:#fafafa;color:#222}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
    .sentence{font-size:24px;line-height:1.6;padding:12px 0;min-height:3.2em}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:10px;padding:10px 14px;font-size:16px;cursor:pointer;background:#2b7cff;color:#fff}
    button.secondary{background:#eee;color:#222}
    button.warn{background:#ff7b2b}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{font-size:14px;color:#555;margin-top:6px;min-height:1.4em}
    .heard{font-size:18px;color:#333;background:#f7f7f7;border-radius:8px;padding:8px 10px;word-break:break-all}
    .stars{font-size:24px;letter-spacing:2px}
    .bigstar{font-size:40px}
    .ok{color:#d80000}
    .meter{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .meter>div{height:100%;background:#2b7cff;width:0%}
    details summary{cursor:pointer;font-weight:600}
    textarea{width:100%;min-height:180px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;line-height:1.6}
    label{font-size:14px;color:#555}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;margin-right:6px}
    .footer{font-size:12px;color:#777;margin-top:10px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .scorebox{font-size:16px}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¤ æœ—è¯»å°çº¢æ˜Ÿï¼ˆè‡ªåŠ¨åˆ¤å®šç‰ˆï¼‰</h1>
    <div class="card">
      <div class="flex">
        <div class="scorebox">â­ å·²è·çº¢æ˜Ÿï¼š<span id="starsCount">0</span></div>
        <span class="pill">è¯†åˆ«è¯­è¨€ï¼šä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼Œç®€ä½“ï¼‰</span>
        <span class="pill">å»ºè®®æµè§ˆå™¨ï¼šChrome / Edgeï¼ˆHTTPSä¸‹å…é‡å¤æˆæƒï¼‰</span>
      </div>
      <div class="sentence" id="sentence">ç‚¹â€œæŠ½ä¸€å¥â€å¼€å§‹</div>
      <div class="btns">
        <button id="btnNext">ğŸ² æŠ½ä¸€å¥</button>
        <button id="btnListen" class="warn" disabled>ğŸ™ï¸ å¼€å§‹æœ—è¯»</button>
        <button id="btnShow" class="secondary">ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ</button>
        <button id="btnReset" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºæ˜Ÿæ˜Ÿ</button>
      </div>
      <div class="status" id="status">â€”</div>
      <div class="meter"><div id="meter"></div></div>
      <div class="heard" id="heard"></div>
      <div class="bigstar" id="bigstar"></div>
    </div>

    <div class="card">
      <details>
        <summary>ğŸ“š å¥å­åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ï¼‰</summary>
        <p class="small">ä¸€è¡Œä¸€ä¸ªå¥å­ï¼Œéšæ—¶å¯æ”¹ã€‚ä¿å­˜åä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚</p>
        <textarea id="sentencesArea">å°çŒ«åœ¨é˜³å°ä¸Šæ™’å¤ªé˜³ã€‚
æ˜¥å¤©æ¥äº†ï¼Œå°è‰å˜ç»¿äº†ã€‚
ä»Šå¤©æ˜¯ä¸ªæ™´æœ—çš„æ—¥å­ã€‚
æˆ‘çˆ±çˆ¸çˆ¸å¦ˆå¦ˆã€‚
è“å¤©ä¸Šé£˜ç€å‡ æœµç™½äº‘ã€‚</textarea>
        <div class="btns">
          <button id="btnSave" class="secondary">ğŸ’¾ ä¿å­˜åˆ—è¡¨</button>
          <button id="btnLoad" class="secondary">â†©ï¸ æ¢å¤ä¸Šæ¬¡ä¿å­˜</button>
          <label><input type="checkbox" id="strict"> ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼ˆâ‰¥95%ï¼‰</label>
        </div>
      </details>
      <div class="footer">æç¤ºï¼šHTTPS ä¸‹ç¬¬ä¸€æ¬¡æˆæƒåï¼Œæœ¬é¡µé¢å¯è¿ç»­ä½¿ç”¨éº¦å…‹é£ã€‚</div>
    </div>
  </div>

  <script>
    const zhNormalize = (s='') => s.toLowerCase()
      .replace(/[ï¼Œ,ã€‚\.ï¼!ï¼Ÿ\?ï¼›;ï¼šâ€œâ€"ã€ã€ã€Œã€\(\)\[\]â€”\-ã€Â·â€¦\s]/g,'');

    function levenshtein(a,b){
      const an=a.length, bn=b.length;
      if(an===0) return bn; if(bn===0) return an;
      const v0=new Array(bn+1).fill(0), v1=new Array(bn+1).fill(0);
      for(let i=0;i<=bn;i++) v0[i]=i;
      for(let i=0;i<an;i++){
        v1[0]=i+1;
        for(let j=0;j<bn;j++){
          const cost=a[i]===b[j]?0:1;
          v1[j+1]=Math.min(v1[j]+1,v0[j+1]+1,v0[j]+cost);
        }
        for(let j=0;j<=bn;j++) v0[j]=v1[j];
      }
      return v1[bn];
    }
    const similarity = (a,b)=>{
      const A=zhNormalize(a),B=zhNormalize(b);
      if(!A && !B) return 1;
      const dist=levenshtein(A,B);
      return 1 - dist/Math.max(A.length,B.length);
    };

    const $=id=>document.getElementById(id);
    const meter=$("meter");
    let pool=[],target="",stars=Number(localStorage.getItem("read_star_stars")||0);
    $("starsCount").textContent=stars;

    function loadSentences(){
      const saved=localStorage.getItem("read_star_sents");
      const text=saved || $("sentencesArea").value;
      pool=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      return pool;
    }
    loadSentences();
    $("btnSave").onclick=()=>{localStorage.setItem("read_star_sents",$("sentencesArea").value);alert("å·²ä¿å­˜åˆ°æœ¬æœº");};
    $("btnLoad").onclick=()=>{const saved=localStorage.getItem("read_star_sents");if(saved){$("sentencesArea").value=saved;loadSentences();alert("å·²æ¢å¤");}else alert("æ— ä¿å­˜");};

    function nextSentence(){
      loadSentences();
      if(pool.length===0){alert("è¯·å…ˆæ·»åŠ å¥å­");return;}
      target=pool[Math.floor(Math.random()*pool.length)];
      $("sentence").textContent=target;
      $("status").textContent="è¯·ç‚¹å¼€å§‹æœ—è¯»";
      $("heard").textContent="";$("bigstar").textContent="";
      meter.style.width="0%";
      $("btnListen").disabled=false;
    }
    $("btnNext").onclick=nextSentence;
    $("btnShow").onclick=()=>{if(target) alert("å¥å­æ˜¯ï¼š\n\n"+target);};
    $("btnReset").onclick=()=>{if(confirm("æ¸…ç©ºæ˜Ÿæ˜Ÿï¼Ÿ")){stars=0;localStorage.setItem("read_star_stars","0");$("starsCount").textContent=0;}};

    let recognition, listening=false, silenceTimer=null, lastHeardTime=0;

    function initReco(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");return null;}
      const r=new SR();
      r.lang="zh-CN"; r.interimResults=true; r.continuous=true;
      return r;
    }

    function startListen(){
      if(!target){nextSentence(); return;}
      recognition=initReco(); if(!recognition) return;
      $("status").textContent="æ­£åœ¨å¬â€¦â€¦";
      $("btnListen").disabled=true;
      listening=true; lastHeardTime=Date.now();
      recognition.onresult=(e)=>{
        let buf="";
        for(let i=e.resultIndex;i<e.results.length;i++){
          buf+=e.results[i][0].transcript;
        }
        $("heard").textContent=buf;
        lastHeardTime=Date.now();
        const sim=similarity(buf,target);
        meter.style.width=Math.round(sim*100)+"%";
      };
      recognition.onerror=(e)=>{$("status").textContent="å‡ºé”™ï¼š"+e.error;};
      recognition.onend=()=>{if(listening) stopListen();};
      recognition.start();
      silenceTimer=setInterval(()=>{
        if(Date.now()-lastHeardTime>5000){stopListen();}
      },500);
    }

    function stopListen(){
      if(recognition){recognition.stop();}
      listening=false; clearInterval(silenceTimer);
      const heard=$("heard").textContent.trim();
      if(!heard){$("status").textContent="æœªè¯†åˆ«åˆ°è¯­éŸ³";return;}
      const sim=similarity(heard,target);
      const strict=$("strict").checked;
      const pass=sim>=(strict?0.95:0.88);
      if(pass){
        stars+=1; localStorage.setItem("read_star_stars",String(stars));
        $("starsCount").textContent=stars;
        $("bigstar").innerHTML="<span class='ok'>â­ å¤ªæ£’äº†ï¼è·å¾—ä¸€é¢—å°çº¢æ˜Ÿï¼</span>";
        $("status").textContent="è‡ªåŠ¨åˆ¤å®šå®Œæˆ";
      }else{
        $("bigstar").textContent="å†è¯•ä¸€æ¬¡å§ï½";
        $("status").textContent="æ²¡å…³ç³»ï¼Œå¯ä»¥æ¢ä¸€å¥";
      }
    }

    $("btnListen").onclick=startListen;
  </script>
</body>
</html>
