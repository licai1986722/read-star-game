<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>朗读小红星（自动判定版）</title>
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue",Arial,"Noto Sans CJK SC",sans-serif;background:#fafafa;color:#222}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
    .sentence{font-size:24px;line-height:1.6;padding:12px 0;min-height:3.2em}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:10px;padding:10px 14px;font-size:16px;cursor:pointer;background:#2b7cff;color:#fff}
    button.secondary{background:#eee;color:#222}
    button.warn{background:#ff7b2b}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{font-size:14px;color:#555;margin-top:6px;min-height:1.4em}
    .heard{font-size:18px;color:#333;background:#f7f7f7;border-radius:8px;padding:8px 10px;word-break:break-all}
    .stars{font-size:24px;letter-spacing:2px}
    .bigstar{font-size:40px}
    .ok{color:#d80000}
    .meter{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .meter>div{height:100%;background:#2b7cff;width:0%}
    details summary{cursor:pointer;font-weight:600}
    textarea{width:100%;min-height:180px;border-radius:10px;border:1px solid #ddd;padding:10px;font-size:14px;line-height:1.6}
    label{font-size:14px;color:#555}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;margin-right:6px}
    .footer{font-size:12px;color:#777;margin-top:10px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .scorebox{font-size:16px}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🎤 朗读小红星（自动判定版）</h1>
    <div class="card">
      <div class="flex">
        <div class="scorebox">⭐ 已获红星：<span id="starsCount">0</span></div>
        <span class="pill">识别语言：中文（普通话，简体）</span>
        <span class="pill">建议浏览器：Chrome / Edge（HTTPS下免重复授权）</span>
      </div>
      <div class="sentence" id="sentence">点“抽一句”开始</div>
      <div class="btns">
        <button id="btnNext">🎲 抽一句</button>
        <button id="btnListen" class="warn" disabled>🎙️ 开始朗读</button>
        <button id="btnShow" class="secondary">👀 显示答案</button>
        <button id="btnReset" class="secondary">🗑️ 清空星星</button>
      </div>
      <div class="status" id="status">—</div>
      <div class="meter"><div id="meter"></div></div>
      <div class="heard" id="heard"></div>
      <div class="bigstar" id="bigstar"></div>
    </div>

    <div class="card">
      <details>
        <summary>📚 句子列表（可编辑）</summary>
        <p class="small">一行一个句子，随时可改。保存后保存在浏览器本地。</p>
        <textarea id="sentencesArea">小猫在阳台上晒太阳。
春天来了，小草变绿了。
今天是个晴朗的日子。
我爱爸爸妈妈。
蓝天上飘着几朵白云。</textarea>
        <div class="btns">
          <button id="btnSave" class="secondary">💾 保存列表</button>
          <button id="btnLoad" class="secondary">↩️ 恢复上次保存</button>
          <label><input type="checkbox" id="strict"> 使用严格模式（≥95%）</label>
        </div>
      </details>
      <div class="footer">提示：HTTPS 下第一次授权后，本页面可连续使用麦克风。</div>
    </div>
  </div>

  <script>
    const zhNormalize = (s='') => s.toLowerCase()
      .replace(/[，,。\.！!？\?；;：“”"『』「」\(\)\[\]—\-、·…\s]/g,'');

    function levenshtein(a,b){
      const an=a.length, bn=b.length;
      if(an===0) return bn; if(bn===0) return an;
      const v0=new Array(bn+1).fill(0), v1=new Array(bn+1).fill(0);
      for(let i=0;i<=bn;i++) v0[i]=i;
      for(let i=0;i<an;i++){
        v1[0]=i+1;
        for(let j=0;j<bn;j++){
          const cost=a[i]===b[j]?0:1;
          v1[j+1]=Math.min(v1[j]+1,v0[j+1]+1,v0[j]+cost);
        }
        for(let j=0;j<=bn;j++) v0[j]=v1[j];
      }
      return v1[bn];
    }
    const similarity = (a,b)=>{
      const A=zhNormalize(a),B=zhNormalize(b);
      if(!A && !B) return 1;
      const dist=levenshtein(A,B);
      return 1 - dist/Math.max(A.length,B.length);
    };

    const $=id=>document.getElementById(id);
    const meter=$("meter");
    let pool=[],target="",stars=Number(localStorage.getItem("read_star_stars")||0);
    $("starsCount").textContent=stars;

    function loadSentences(){
      const saved=localStorage.getItem("read_star_sents");
      const text=saved || $("sentencesArea").value;
      pool=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      return pool;
    }
    loadSentences();
    $("btnSave").onclick=()=>{localStorage.setItem("read_star_sents",$("sentencesArea").value);alert("已保存到本机");};
    $("btnLoad").onclick=()=>{const saved=localStorage.getItem("read_star_sents");if(saved){$("sentencesArea").value=saved;loadSentences();alert("已恢复");}else alert("无保存");};

    function nextSentence(){
      loadSentences();
      if(pool.length===0){alert("请先添加句子");return;}
      target=pool[Math.floor(Math.random()*pool.length)];
      $("sentence").textContent=target;
      $("status").textContent="请点开始朗读";
      $("heard").textContent="";$("bigstar").textContent="";
      meter.style.width="0%";
      $("btnListen").disabled=false;
    }
    $("btnNext").onclick=nextSentence;
    $("btnShow").onclick=()=>{if(target) alert("句子是：\n\n"+target);};
    $("btnReset").onclick=()=>{if(confirm("清空星星？")){stars=0;localStorage.setItem("read_star_stars","0");$("starsCount").textContent=0;}};

    let recognition, listening=false, silenceTimer=null, lastHeardTime=0;

    function initReco(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){alert("浏览器不支持语音识别");return null;}
      const r=new SR();
      r.lang="zh-CN"; r.interimResults=true; r.continuous=true;
      return r;
    }

    function startListen(){
      if(!target){nextSentence(); return;}
      recognition=initReco(); if(!recognition) return;
      $("status").textContent="正在听……";
      $("btnListen").disabled=true;
      listening=true; lastHeardTime=Date.now();
      recognition.onresult=(e)=>{
        let buf="";
        for(let i=e.resultIndex;i<e.results.length;i++){
          buf+=e.results[i][0].transcript;
        }
        $("heard").textContent=buf;
        lastHeardTime=Date.now();
        const sim=similarity(buf,target);
        meter.style.width=Math.round(sim*100)+"%";
      };
      recognition.onerror=(e)=>{$("status").textContent="出错："+e.error;};
      recognition.onend=()=>{if(listening) stopListen();};
      recognition.start();
      silenceTimer=setInterval(()=>{
        if(Date.now()-lastHeardTime>5000){stopListen();}
      },500);
    }

    function stopListen(){
      if(recognition){recognition.stop();}
      listening=false; clearInterval(silenceTimer);
      const heard=$("heard").textContent.trim();
      if(!heard){$("status").textContent="未识别到语音";return;}
      const sim=similarity(heard,target);
      const strict=$("strict").checked;
      const pass=sim>=(strict?0.95:0.88);
      if(pass){
        stars+=1; localStorage.setItem("read_star_stars",String(stars));
        $("starsCount").textContent=stars;
        $("bigstar").innerHTML="<span class='ok'>⭐ 太棒了！获得一颗小红星！</span>";
        $("status").textContent="自动判定完成";
      }else{
        $("bigstar").textContent="再试一次吧～";
        $("status").textContent="没关系，可以换一句";
      }
    }

    $("btnListen").onclick=startListen;
  </script>
</body>
</html>
