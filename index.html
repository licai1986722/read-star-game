<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœ—è¯»å°çº¢æ˜Ÿ Â· Read-Aloud Stars (Bilingual Â· Stable)</title>
  <style>
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue",Arial,"Noto Sans CJK SC",sans-serif;background:#fafafa;color:#222}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:14px;margin-bottom:14px}
    .sentence{font-size:24px;line-height:1.6;padding:12px 0;min-height:3.2em;position:relative}
    #sentenceText{display:inline}
    #sentenceTip{opacity:.6}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:10px;padding:10px 14px;font-size:16px;cursor:pointer;background:#2b7cff;color:#fff}
    button.secondary{background:#eee;color:#222}
    button.warn{background:#ff7b2b}
    button.success{background:#16a34a}
    button.ghost{background:#f5f5f5;color:#222}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{font-size:14px;color:#555;margin-top:6px;min-height:1.4em}
    .heard{font-size:18px;color:#333;background:#f7f7f7;border-radius:8px;padding:8px 10px;word-break:break-all}
    .bigstar{font-size:40px}
    .ok{color:#d80000}
    .meter{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .meter>div{height:100%;background:#2b7cff;width:0%}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0f0f0;margin-right:6px}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .scorebox{font-size:16px}
    .badge{background:#f0f0ff;border:1px solid #e0e0ff;border-radius:999px;padding:2px 8px}
    input[type=text]{padding:8px;border:1px solid #ddd;border-radius:8px;min-width:180px}
    ul{list-style:none;padding:0;margin:0}
    li{display:flex;align-items:center;gap:8px;margin:6px 0}
    .thumb{width:80px;height:60px;object-fit:cover;border:1px solid #ddd;border-radius:6px;background:#f8f8f8}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;}
    .modal .panel{background:#fff;border-radius:16px;max-width:980px;width:100%;padding:12px 12px 16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .modal.small .panel{max-width:420px}
    .panel h2{margin:8px 0 8px;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .toolbar input[type=range]{width:120px}
    .canvas-wrap{width:100%;aspect-ratio:4/3;border:1px dashed #ddd;border-radius:12px;overflow:hidden;background:#fff;position:relative}
    .view{width:100%;height:100%;display:block;touch-action:none}
    .swatch{width:24px;height:24px;border-radius:50%;border:1px solid #ccc;cursor:pointer}
    .hint{font-size:12px;color:#666}
    .warnnote{font-size:12px;color:#aa0000}
    .gallery{display:flex;gap:8px;overflow:auto;padding:8px 0}
    .gitem{flex:0 0 auto;border:2px solid transparent;border-radius:10px;padding:2px;cursor:pointer;background:#fff}
    .gitem.active{border-color:#2b7cff}
    .gitem img{display:block;width:120px;height:90px;object-fit:cover;border-radius:8px}
    .note{font-size:12px;color:#666;margin-left:6px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .gear{background:#f0f0f0;color:#333;border-radius:10px;border:1px solid #e5e5e5;cursor:pointer}
    .langpill{background:#eef7ff;border:1px solid #cfe6ff;border-radius:999px;padding:2px 8px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .label{font-size:14px;color:#555}
    .row input[type=number]{width:80px}
    /* ğŸ² Dice animation 2s */
    .dice{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:52px;height:52px;border-radius:10px;background:#fff;border:2px solid #333;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none}
    .dot{width:8px;height:8px;background:#333;border-radius:50%;position:absolute}
    .dot.c{left:50%;top:50%;transform:translate(-50%,-50%)}
    .dot.tl{left:12px;top:12px}.dot.tr{right:12px;top:12px}
    .dot.bl{left:12px;bottom:12px}.dot.br{right:12px;bottom:12px}
    .dot.ml{left:12px;top:50%;transform:translateY(-50%)}.dot.mr{right:12px;top:50%;transform:translateY(-50%)}
    .rolling{animation:roll 2s ease-in-out both}
    @keyframes roll{
      0%{opacity:1;transform:translate(-50%,-50%) rotate(0) scale(1)}
      25%{transform:translate(calc(-50% - 10px),calc(-50% - 8px)) rotate(120deg) scale(1.1)}
      50%{transform:translate(calc(-50% + 12px),calc(-50% + 6px)) rotate(260deg) scale(0.95)}
      75%{transform:translate(calc(-50% - 6px),calc(-50% + 4px)) rotate(320deg) scale(1.05)}
      100%{opacity:0;transform:translate(-50%,-50%) rotate(360deg) scale(1)}
    }
    /* error toast */
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;display:none;z-index:1000}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 id="titleH1">ğŸ¤ æœ—è¯»å°çº¢æ˜Ÿ</h1>
      <div class="row">
        <span class="langpill"><span id="langLabel">è¯­è¨€ / Languageï¼š</span><strong id="langShow">ä¸­æ–‡</strong></span>
        <button id="btnParent" class="gear" role="button" aria-haspopup="dialog">âš™ï¸ <span id="parentBtnText">å®¶é•¿è®¾ç½®</span></button>
      </div>
    </div>

    <div class="card">
      <div class="flex">
        <div class="scorebox"><span id="scoreLabel">â­ å·²è·çº¢æ˜Ÿï¼š</span><span id="starsCount">0</span></div>
        <span class="pill" id="recHint">è¯†åˆ«è¯­è¨€ï¼šä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰</span>
        <span class="pill" id="browserHint">å»ºè®®æµè§ˆå™¨ï¼šChrome / Edgeï¼ˆHTTPS æ›´ç¨³å®šï¼‰</span>
        <span class="badge" id="rewardHint">å¥–åŠ±ï¼šæ¯æ»¡ N æ˜Ÿå¼¹å‡ºæ¶‚è‰²</span>
      </div>

      <div class="sentence" id="sentence">
        <span id="sentenceText"></span>
        <span id="sentenceTip">ç‚¹â€œæŠ½ä¸€å¥â€å¼€å§‹</span>
        <div id="dice" class="dice">
          <div class="dot tl"></div><div class="dot tr"></div>
          <div class="dot ml"></div><div class="dot c"></div><div class="dot mr"></div>
          <div class="dot bl"></div><div class="dot br"></div>
        </div>
      </div>
      <div class="btns">
        <button id="btnNext">ğŸ² æŠ½ä¸€å¥</button>
        <button id="btnListen" class="warn" disabled>ğŸ™ï¸ å¼€å§‹æœ—è¯»</button>
        <button id="btnStop" class="success" disabled>â¹ï¸ ç»“æŸåˆ¤å®š</button>
        <button id="btnRetry" class="secondary" disabled>ğŸ” é‡è¯•æœ¬å¥</button>
        <button id="btnShow" class="secondary">ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ</button>
        <button id="btnColorNow" class="secondary">ğŸ¨ å»æ¶‚è‰²</button>
        <button id="btnReset" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºæ˜Ÿæ˜Ÿ</button>
      </div>
      <div class="status" id="status">â€”</div>
      <div class="meter"><div id="meter"></div></div>
      <div class="heard" id="heard"></div>
      <div class="bigstar" id="bigstar"></div>
    </div>

    <div class="card">
      <details>
        <summary id="sentencesSummary">ğŸ“š å¥å­åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ï¼‰</summary>
        <textarea id="sentencesArea" style="display:none"></textarea>
        <div class="hint" id="sentencesHint">å¥å­åˆ—è¡¨é»˜è®¤éšè—ï¼Œä»…å®¶é•¿æ¨¡å¼å¯è§å¹¶ç¼–è¾‘ã€‚</div>
      </details>
    </div>

    <div class="card">
      <details>
        <summary id="imagesSummary">ğŸ–¼ï¸ å¥–åŠ±æ¶‚è‰²å›¾ç‰‡ï¼ˆç½‘ç»œé“¾æ¥ / æœ¬åœ°ä¸Šä¼  / ç›®å½•æ¸…å•ï¼‰</summary>
        <div class="hint" id="imagesHint">å›¾ç‰‡ç®¡ç†é»˜è®¤éšè—ï¼Œä»…å®¶é•¿æ¨¡å¼å¯è§ã€‚å°æœ‹å‹å¯åœ¨å¥–åŠ±å¼¹çª—ä¸­ä»ç¼©ç•¥å›¾é€‰æ‹©ã€‚</div>
        <ul id="imgList"></ul>
      </details>
    </div>
  </div>

  <!-- Parent modal (PIN lock) -->
  <div class="modal small" id="parentModal" aria-hidden="true" style="z-index:120;">
    <div class="panel">
      <h2 id="parentTitle">ğŸ” å®¶é•¿è®¾ç½®</h2>
      <div id="pinView" class="grid">
        <label class="label" id="pinLabel">è¾“å…¥å®¶é•¿ PINï¼ˆé»˜è®¤ 1234ï¼‰ï¼š</label>
        <div class="row">
          <input id="pinInput" type="password" placeholder="1234" />
          <button id="pinOk">è¿›å…¥</button>
          <button id="pinCancel" class="secondary">å–æ¶ˆ</button>
        </div>
      </div>
      <div id="settingsView" style="display:none">
        <div class="grid">
          <div class="row">
            <label class="label" id="thresLabel">åˆ¤å®šé˜ˆå€¼ï¼š</label>
            <input id="thres" type="range" min="70" max="98" value="85"> <span id="thresVal">85</span>%
            <button id="btnThresReset" class="secondary">é˜ˆå€¼å¤ä½ 85%</button>
          </div>
          <div class="row">
            <label class="label" id="rewardStepLabel">å¥–åŠ±é˜ˆå€¼ï¼ˆæ¯ N æ˜Ÿï¼‰ï¼š</label>
            <input id="rewardStep" type="range" min="1" max="20" value="5"> <span id="rewardVal">5</span>
            <span id="rewardUnit">æ˜Ÿ</span>
            <button id="btnRewardReset" class="secondary">å¥–åŠ±å¤ä½ 5 æ˜Ÿ</button>
          </div>
          <div class="row">
            <label class="label" id="kidNameLabel">å°æœ‹å‹åå­—ï¼š</label>
            <input id="kidName" type="text" placeholder="kalie" value="kalie">
            <button id="btnSaveKid" class="secondary">ä¿å­˜åå­—</button>
          </div>
          <div class="row">
            <label class="label" id="langSelLabel">æµ‹è¯•è¯­è¨€ï¼š</label>
            <select id="langSel">
              <option value="zh">ä¸­æ–‡</option>
              <option value="en">English</option>
            </select>
            <span class="hint" id="langHint">å½±å“ç•Œé¢è¯­è¨€ä¸è¯­éŸ³è¯†åˆ«è¯­è¨€ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ã€‚é¼“åŠ±è¯­éŸ³å§‹ç»ˆä¸ºè‹±æ–‡ã€‚</span>
          </div>
          <hr>
          <div class="row">
            <input type="text" id="imgUrl" placeholder="ç²˜è´´ç½‘ç»œå›¾ç‰‡åœ°å€ï¼ˆå…è®¸CORSæœ€ä½³ï¼‰">
            <button id="btnAddUrl" class="secondary">æ·»åŠ ç½‘ç»œå›¾ç‰‡</button>
          </div>
          <div class="row">
            <input type="file" id="imgFile" accept="image/*">
            <button id="btnAddFile" class="secondary">ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</button>
          </div>
          <div class="row">
            <button id="btnLoadManifest" class="secondary">ä»ç›®å½•æ¸…å•è½½å…¥</button>
            <span class="hint" id="manifestHint">åœ¨åŒç›®å½•æ”¾ <code>reward_images.json</code> æˆ– <code>reward_images.txt</code>ã€‚</span>
          </div>
          <div class="row">
              <button id="btnEditSentences" class="secondary">ç¼–è¾‘å¥å­åˆ—è¡¨</button>
            <button id="btnResetZH" class="secondary">æ¢å¤ä¸­æ–‡30å¥</button>
            <button id="btnClearZH" class="secondary">æ¸…ç©ºä¸­æ–‡å¥å­</button>
            <button id="btnClearEN" class="secondary">æ¸…ç©ºè‹±æ–‡å¥å­</button>
            <button id="btnCloseParent">å®Œæˆ</button>
          </div>
        </div>
        <ul id="imgListParent"></ul>
      </div>
    </div>
  </div>

  <!-- Reward modal -->
  <div class="modal" id="rewardModal" aria-hidden="true" style="z-index:110;">
    <div class="panel">
      <h2 id="rewardTitle">ğŸ é€‰æ‹©è¦æ¶‚è‰²çš„å›¾ç‰‡ï¼Œç„¶åå¼€å§‹ä¸Šè‰² <span class="note">ï¼ˆUndoæŒ‰é’®/å³é”®æ’¤é”€ï¼›æ»šè½®/åŒæŒ‡ç¼©æ”¾ï¼›æ‹–åŠ¨å¹³ç§»ï¼‰</span></h2>
      <div id="gallery" class="gallery"></div>
      <div class="toolbar">
        <div><span id="brushLabel">ç”»ç¬”ï¼š</span><input type="range" id="brush" min="2" max="48" value="16"> <span id="brushSize">16</span> px</div>
        <div class="row">
          <span id="tolLabel">å¡«å……å®¹å·®ï¼š</span><input type="range" id="tol" min="0" max="60" value="20"><span id="tolVal">20</span>
        </div>
        <div id="palette" class="row"></div>
        <div class="row toolline">
          <span id="viewLabel">è§†å›¾ï¼š</span>
          <button id="zoomOut" class="ghost">-</button>
          <input type="range" id="zoom" min="50" max="200" value="100">
          <button id="zoomIn" class="ghost">+</button>
          <button id="fit" class="ghost">é€‚é…</button>
          <span class="tooltoggle">
            <button id="toolPaint" class="ghost">ğŸ–Œï¸ç”»ç¬”</button>
            <button id="toolBucket" class="ghost">ğŸª£é¢œæ–™æ¡¶</button>
            <button id="toolPan" class="ghost">ğŸ–ï¸ç§»åŠ¨</button>
          </span>
          <button id="undoBtn" class="secondary">â†©ï¸ æ’¤é”€</button>
        </div>
        <div class="row">
          <button id="btnClear" class="secondary">æ¸…é™¤æ‰€æœ‰æ”¹åŠ¨</button>
          <button id="btnSaveImg" class="secondary">ä¿å­˜åˆ°ç›¸å†Œ</button>
          <button id="btnClose">å®Œæˆ</button>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="view" class="view" width="1400" height="1050"></canvas>
      </div>
      <div id="corsWarn" class="warnnote" style="display:none;">æç¤ºï¼šå½“å‰å›¾ç‰‡æ¥æºä¸æ”¯æŒè·¨åŸŸï¼Œä»å¯æ¶‚è‰²ï¼Œä½†å¯èƒ½æ— æ³•ä¿å­˜ä¸º PNGã€‚</div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* --- Crash guard: show toast on error --- */
window.addEventListener('error', (e)=>{
  console.error(e);
  const t=document.getElementById('toast');
  t.textContent = 'âš ï¸ è„šæœ¬é”™è¯¯ï¼š' + (e.message||'unknown');
  t.style.display='block';
  setTimeout(()=>t.style.display='none', 4000);
});

/* ---------- i18n ---------- */
const I18N = {
  zh: { title:"ğŸ¤ æœ—è¯»å°çº¢æ˜Ÿ", langLabel:"è¯­è¨€ / Languageï¼š", parentBtn:"å®¶é•¿è®¾ç½®",
    scoreLabel:"â­ å·²è·çº¢æ˜Ÿï¼š", recHint:"è¯†åˆ«è¯­è¨€ï¼šä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰", browserHint:"å»ºè®®æµè§ˆå™¨ï¼šChrome / Edgeï¼ˆHTTPS æ›´ç¨³å®šï¼‰",
    rewardHint:"å¥–åŠ±ï¼šæ¯æ»¡ N æ˜Ÿå¼¹å‡ºæ¶‚è‰²", sentenceTip:"ç‚¹â€œæŠ½ä¸€å¥â€å¼€å§‹", btnNext:"ğŸ² æŠ½ä¸€å¥", btnListen:"ğŸ™ï¸ å¼€å§‹æœ—è¯»",
    btnStop:"â¹ï¸ ç»“æŸåˆ¤å®š", btnRetry:"ğŸ” é‡è¯•æœ¬å¥", btnShow:"ğŸ‘€ æ˜¾ç¤ºç­”æ¡ˆ", btnColorNow:"ğŸ¨ å»æ¶‚è‰²", btnReset:"ğŸ—‘ï¸ æ¸…ç©ºæ˜Ÿæ˜Ÿ",
    sentencesSummary:"ğŸ“š å¥å­åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ï¼‰", sentencesHint:"å¥å­åˆ—è¡¨é»˜è®¤éšè—ï¼Œä»…å®¶é•¿æ¨¡å¼å¯è§å¹¶ç¼–è¾‘ã€‚",
    imagesSummary:"ğŸ–¼ï¸ å¥–åŠ±æ¶‚è‰²å›¾ç‰‡ï¼ˆç½‘ç»œé“¾æ¥ / æœ¬åœ°ä¸Šä¼  / ç›®å½•æ¸…å•ï¼‰", imagesHint:"å›¾ç‰‡ç®¡ç†é»˜è®¤éšè—ï¼Œä»…å®¶é•¿æ¨¡å¼å¯è§ã€‚å°æœ‹å‹å¯åœ¨å¥–åŠ±å¼¹çª—ä¸­ä»ç¼©ç•¥å›¾é€‰æ‹©ã€‚",
    parentTitle:"ğŸ” å®¶é•¿è®¾ç½®", pinLabel:"è¾“å…¥å®¶é•¿ PINï¼ˆé»˜è®¤ 1234ï¼‰ï¼š", pinOk:"è¿›å…¥", pinCancel:"å–æ¶ˆ",
    thresLabel:"åˆ¤å®šé˜ˆå€¼ï¼š", btnThresReset:"é˜ˆå€¼å¤ä½ 85%", rewardStepLabel:"å¥–åŠ±é˜ˆå€¼ï¼ˆæ¯ N æ˜Ÿï¼‰ï¼š", btnRewardReset:"å¥–åŠ±å¤ä½ 5 æ˜Ÿ",
    kidNameLabel:"å°æœ‹å‹åå­—ï¼š", btnSaveKid:"ä¿å­˜åå­—", langSelLabel:"æµ‹è¯•è¯­è¨€ï¼š",
    langHint:"å½±å“ç•Œé¢è¯­è¨€ä¸è¯­éŸ³è¯†åˆ«è¯­è¨€ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ã€‚é¼“åŠ±è¯­éŸ³å§‹ç»ˆä¸ºè‹±æ–‡ã€‚", btnResetZH:"æ¢å¤ä¸­æ–‡30å¥", btnClearEN:"æ¸…ç©ºè‹±æ–‡å¥å­", btnClearZH:"æ¸…ç©ºä¸­æ–‡å¥å­", 
    manifestHint:"åœ¨åŒç›®å½•æ”¾ reward_images.json æˆ– reward_images.txtã€‚", btnAddUrl:"æ·»åŠ ç½‘ç»œå›¾ç‰‡", btnAddFile:"ä¸Šä¼ æœ¬åœ°å›¾ç‰‡",
    btnLoadManifest:"ä»ç›®å½•æ¸…å•è½½å…¥", btnEditSentences:"ç¼–è¾‘å¥å­åˆ—è¡¨", btnCloseParent:"å®Œæˆ",
    rewardTitle:"ğŸ é€‰æ‹©è¦æ¶‚è‰²çš„å›¾ç‰‡ï¼Œç„¶åå¼€å§‹ä¸Šè‰² ï¼ˆUndoæŒ‰é’®/å³é”®æ’¤é”€ï¼›æ»šè½®/åŒæŒ‡ç¼©æ”¾ï¼›æ‹–åŠ¨å¹³ç§»ï¼‰",
    brushLabel:"ç”»ç¬”ï¼š", tolLabel:"å¡«å……å®¹å·®ï¼š", viewLabel:"è§†å›¾ï¼š", fit:"é€‚é…", toolPaint:"ğŸ–Œï¸ç”»ç¬”", toolBucket:"ğŸª£é¢œæ–™æ¡¶",
    toolPan:"ğŸ–ï¸ç§»åŠ¨", undoBtn:"â†©ï¸ æ’¤é”€", btnClear:"æ¸…é™¤æ‰€æœ‰æ”¹åŠ¨", btnSaveImg:"ä¿å­˜åˆ°ç›¸å†Œ", btnClose:"å®Œæˆ",
    corsWarn:"æç¤ºï¼šå½“å‰å›¾ç‰‡æ¥æºä¸æ”¯æŒè·¨åŸŸï¼Œä»å¯æ¶‚è‰²ï¼Œä½†å¯èƒ½æ— æ³•ä¿å­˜ä¸º PNGã€‚",
    listening:"æ­£åœ¨å¬â€¦â€¦", tapStart:"è¯·ç‚¹å¼€å§‹æœ—è¯»", noVoice:"æœªè¯†åˆ«åˆ°è¯­éŸ³",
    done:(s,t)=>`åˆ¤å®šå®Œæˆï¼ˆç›¸ä¼¼åº¦ï¼š${s}%ï¼Œé˜ˆå€¼ï¼š${t}%ï¼‰`, notpass:(s,t)=>`æœªé€šè¿‡ï¼ˆç›¸ä¼¼åº¦ï¼š${s}%ï¼Œé˜ˆå€¼ï¼š${t}%ï¼‰ã€‚å¯ä»¥ç‚¹â€œé‡è¯•æœ¬å¥â€ã€‚`,
    rewardUnit:"æ˜Ÿ"
  },
  en: { title:"ğŸ¤ Read-Aloud Stars", langLabel:"Languageï¼š", parentBtn:"Parent Settings",
    scoreLabel:"â­ Stars earned: ", recHint:"Recognition language: English (US)",
    browserHint:"Recommended: Chrome / Edge (HTTPS is more stable)",
    rewardHint:"Reward: Coloring pops up every N stars", sentenceTip:"Tap â€œRollâ€ to start", btnNext:"ğŸ² Roll",
    btnListen:"ğŸ™ï¸ Start", btnStop:"â¹ï¸ Stop & Judge", btnRetry:"ğŸ” Retry This Line", btnShow:"ğŸ‘€ Show Answer",
    btnColorNow:"ğŸ¨ Coloring", btnReset:"ğŸ—‘ï¸ Reset Stars", sentencesSummary:"ğŸ“š Sentence List (Editable)",
    sentencesHint:"Hidden by default; visible in Parent Settings only.",
    imagesSummary:"ğŸ–¼ï¸ Reward Coloring Images (URL / Local Upload / Manifest)",
    imagesHint:"Hidden by default; kids choose from thumbnails in the reward modal.",
    parentTitle:"ğŸ” Parent Settings", pinLabel:"Enter Parent PIN (default 1234):", pinOk:"Enter", pinCancel:"Cancel",
    thresLabel:"Pass threshold:", btnThresReset:"Reset to 85%", rewardStepLabel:"Reward every (N) stars:",
    btnRewardReset:"Reset to 5 stars", kidNameLabel:"Child's name:", btnSaveKid:"Save name",
    langSelLabel:"Test language:", langHint:"Controls UI language and recognition language (Chinese/English). Encouragement voice is always English.", btnResetZH:"Reset Chinese 30 test sentences", btnClearEN:"Clear English test sentences", 
    btnClearZH:"Clear Chinese test sentences", 
    manifestHint:"Place reward_images.json or reward_images.txt in the same folder.", btnAddUrl:"Add image URL",
    btnAddFile:"Upload local image", btnLoadManifest:"Load from manifest", btnEditSentences:"Edit sentences",
    btnCloseParent:"Done", rewardTitle:"ğŸ Pick an image and start coloring (Undo/right-click; wheel/pinch zoom; drag to pan)",
    brushLabel:"Brush:", tolLabel:"Fill tolerance:", viewLabel:"View:", fit:"Fit", toolPaint:"ğŸ–Œï¸Brush",
    toolBucket:"ğŸª£Bucket", toolPan:"ğŸ–ï¸Pan", undoBtn:"â†©ï¸ Undo", btnClear:"Clear changes", btnSaveImg:"Save as PNG",
    btnClose:"Done", corsWarn:"Note: Cross-origin image; coloring OK but saving PNG may be blocked.",
    listening:"Listeningâ€¦", tapStart:"Tap Start to read aloud", noVoice:"No voice detected",
    done:(s,t)=>`Done. Similarity: ${s}%, Threshold: ${t}%`, notpass:(s,t)=>`Not passed. Similarity: ${s}%, Threshold: ${t}%`,
    rewardUnit:"stars"
  }
};

/* ---------- Utils ---------- */
const $ = id => document.getElementById(id);
const zhNormalize = s => s.toLowerCase().replace(/[ï¼Œ,ã€‚\.ï¼!ï¼Ÿ\?ï¼›;ï¼šâ€œâ€"ã€ã€ã€Œã€\(\)\[\]â€”\-ã€Â·â€¦\s]/g,'');
function levenshtein(a,b){const an=a.length,bn=b.length;if(an===0)return bn;if(bn===0)return an;const v0=new Array(bn+1).fill(0),v1=new Array(bn+1).fill(0);for(let i=0;i<=bn;i++)v0[i]=i;for(let i=0;i<an;i++){v1[0]=i+1;for(let j=0;j<bn;j++){const cost=a[i]===b[j]?0:1;v1[j+1]=Math.min(v1[j]+1,v0[j+1]+1,v0[j]+cost);}for(let j=0;j<=bn;j++)v0[j]=v1[j];}return v1[bn];}
const similarity=(a,b)=>{const A=zhNormalize(a),B=zhNormalize(b);if(!A&&!B)return 1;return 1-levenshtein(A,B)/Math.max(A.length,B.length);};
function speakEN(text){ if(!('speechSynthesis'in window))return; const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; speechSynthesis.speak(u); }
function textOr(id, value){const el=$(id); if(el && value!=null) el.textContent=value;}

/* ---------- Storage keys ---------- */
const THRES_KEY='read_star_threshold', REWARD_STEP_KEY='read_star_reward_step', KID_NAME_KEY='read_star_kid_name', LANG_KEY='read_star_lang', PIN_KEY='read_star_pin';

/* ---------- Parent lock ---------- */
const parentBtn=$('btnParent'), parentModal=$('parentModal'), pinView=$('pinView'), settingsView=$('settingsView');
const pinInput=$('pinInput'); const pinOk=$('pinOk'); const pinCancel=$('pinCancel');
parentBtn.addEventListener('click', ()=>{ parentModal.style.display='flex'; parentModal.setAttribute('aria-hidden','false'); pinView.style.display='block'; settingsView.style.display='none'; pinInput.value=''; });
pinCancel.addEventListener('click', ()=>{ parentModal.style.display='none'; });
pinOk.addEventListener('click', ()=>{
  const stored=localStorage.getItem(PIN_KEY)||'1234';
  if((pinInput.value||'')===stored){ pinView.style.display='none'; settingsView.style.display='block'; }
  else alert(appLang==='en'?'Wrong PIN':'PIN ä¸æ­£ç¡®');
});

/* ---------- Settings ---------- */
const thresEl=$('thres'), thresVal=$('thresVal');
const rewardEl=$('rewardStep'), rewardVal=$('rewardVal'), rewardUnit=$('rewardUnit');
const kidNameEl=$('kidName'); const langSel=$('langSel'), langShow=$('langShow');
function loadThreshold(){const v=Number(localStorage.getItem(THRES_KEY));const t=(isNaN(v)||v<70||v>98)?85:v;thresEl.value=t;thresVal.textContent=t;return t/100;}
function saveThreshold(){thresVal.textContent=thresEl.value;localStorage.setItem(THRES_KEY,thresEl.value);}
$('btnThresReset').onclick=()=>{thresEl.value=85;saveThreshold();};
thresEl.oninput=saveThreshold;
function loadRewardStep(){const v=Number(localStorage.getItem(REWARD_STEP_KEY));const t=(isNaN(v)||v<1||v>20)?5:v;rewardEl.value=t;rewardVal.textContent=t;return t;}
function saveRewardStep(){rewardVal.textContent=rewardEl.value;localStorage.setItem(REWARD_STEP_KEY,rewardEl.value);}
$('btnRewardReset').onclick=()=>{rewardEl.value=5;saveRewardStep();};
rewardEl.oninput=saveRewardStep;
function loadKidName(){const v=localStorage.getItem(KID_NAME_KEY)||'kalie';kidNameEl.value=v;return v;}
$('btnSaveKid').onclick=()=>{localStorage.setItem(KID_NAME_KEY,kidNameEl.value.trim()||'kalie');alert((appLang==='en'?'Saved: ':'å·²ä¿å­˜åå­—ï¼š')+(kidNameEl.value.trim()||'kalie'));};

function loadLang(){const v=localStorage.getItem(LANG_KEY)||'zh';langSel.value=v;langShow.textContent=(v==='en'?'English':'ä¸­æ–‡');document.documentElement.lang=(v==='en'?'en':'zh-CN');return v;}
let appLang=loadLang();
langSel.addEventListener('change', ()=>{
  localStorage.setItem(LANG_KEY, langSel.value);
  appLang = langSel.value;
  applyI18n();
  loadSentences();
});

/* ---------- Encouragement (always EN) ---------- */
const PASS_EN = [n=>`${n}, you did an amazing job!`, n=>`${n}, that was perfect!`, n=>`${n}, you nailed it!`, n=>`Excellent work, ${n}!`, n=>`Awesome, ${n}! Keep it up!`];
const FAIL_EN = [n=>`${n}, keep trying!`, n=>`${n}, donâ€™t give up!`, n=>`${n}, letâ€™s try that again!`, n=>`Almost there, ${n}!`];
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ---------- Core state ---------- */
let pool=[],target='',stars=Number(localStorage.getItem('read_star_stars')||0);$('starsCount').textContent=stars;

function defaultSentencesZH(){return `èƒ–å¨ƒå¨ƒçš„è„è¡£æœæ‰è¿›æ°´é‡Œäº†ï¼Œå°è¢‹é¼ çœ‹è§å°±ç¬‘äº†ã€‚
å°é¸­å­çˆ¬ä¸ä¸Šè·¯è¾¹çš„æ¡ƒæ ‘ï¼Œåªå¥½åœ¨æ ‘åº•ä¸‹èµ°æ¥èµ°å»ã€‚
ä»–ä¸€ä¸ªäººåœ¨å¼¯å¼¯çš„é“è·¯ä¸Šï¼Œä½å¤´çœ‹è§è·¯è¾¹æœ‰å¥½å¤šçš„æœ¨å¤´ã€‚
æˆ‘çŸ¥é“å¦ˆå¦ˆæœ‰äº”ä»¶è“è¡£æœã€å…­æ¡é»‘è£¤å­ï¼Œè¿˜æœ‰ä¸€é¢å¤§é•œå­ã€‚
ä¸‰åŒ¹å°é©¬çš„å¥½æœ‹å‹ä¸ä¼šçˆ¬æ ‘ï¼Œåªä¼šå“­ã€‚
æ˜¥å¤©æ¥äº†ï¼Œå°è‰å˜ç»¿äº†ï¼Œæ¡ƒæ ‘å¼€èŠ±äº†ï¼Œå°é¸Ÿé£æ¥äº†ã€‚
å¤§èƒ–å­è„±ä¸‹äº†è„çš„çº¢è£¤å­ï¼Œæ¢ä¸Šäº†ä¸€æ¡æœ‰ä¸¤ä¸ªå£è¢‹çš„é»‘è£¤å­ã€‚
å¬é£å£°é›¨å£°å°±çŸ¥é“é›¨æœ‰å¤šå¤§äº†ã€‚
æˆ‘æœ‰ä¸¤ä»¶ç»¿è¡£æœï¼Œèƒ¸å‰éƒ½æœ‰ä¸€æœµå¤§çº¢èŠ±ã€‚
å°–å°–çš„èˆ¹å¤´ä¸Šé£æ¥äº†ä¸€åªçº¢å˜´å·´çš„å°é¸Ÿï¼Œèˆ¹å°¾èµ°æ¥ä¸€åªå°è€³æœµçš„å…¬é¸¡ã€‚
æ¡ƒæ ‘ä¸Šåˆ°åº•è¿˜å‰©å‡ ä¸ªæ¡ƒå­ï¼Ÿ
ä¸€ç™¾ä¸ªèåœåŠ å…«ä¸ªèåœï¼Œç®—ä¸€ç®—ä¸€å…±æœ‰å¤šå°‘ä¸ªèåœï¼Ÿ
å°èŒèšªé•¿å‡ºå‰è…¿å’Œåè…¿ï¼Œå˜æˆäº†ä¸€åªå°é’è›™ï¼é’è›™çš„è„‘è¢‹æ¯”å°èŒèšªçš„å¤§äº†å¥½å¤šï¼
ä¸€ç¾¤å°é¸­å­èµ°è¿›ä½ å®¶å¤§é—¨ï¼Œéƒ½æ²¡çœ‹è§é—¨ä¸Šæœ‰ä¸€æ¡å¤§æ¯›æ¯›è™«ã€‚
æˆ‘çš„å¥½æœ‹å‹åœ¨å±‹å­é‡Œåç€ã€‚
æˆ‘åšäº†ä¸¤ä»¶äº‹ï¼Œå»çˆ¬äº†ä¸€åº§å±±ï¼Œåˆ°å®¶åæŒ‚ä¸Šäº†æˆ‘çš„è¡£æœã€‚
çº¢è‰²çš„ç«ï¼Œé»„è‰²çš„åœŸï¼Œé’è‰²çš„è‰ï¼Œç»¿è‰²çš„æ ‘ï¼Œè“è‰²çš„å¤©ï¼Œåªæœ‰èŒèšªçš„è„¸å„¿é»‘ã€‚
ä½ çš„å·¦æ‰‹å¥½è„ï¼Œä½ çš„è„¸ä¸Šä¹Ÿå¥½è„ã€‚
æˆ‘çŸ¥é“å¦ˆå¦ˆçˆ±æˆ‘ï¼Œè¿˜çŸ¥é“çˆ¸çˆ¸çˆ±æˆ‘ï¼›æˆ‘ä¹Ÿçˆ±çˆ¸çˆ¸å¦ˆå¦ˆã€‚
ä¸‹é›ªäº†ï¼Œå®¶é—¨å£çš„å¤§é»‘çŸ³å¤´ä¸è§äº†ã€‚å’¦ï¼Œå˜æˆå¤§ç™½çŸ³å¤´å•¦ï¼
æœ‰ä¸ƒæ¡æ¯›æ¯›è™«çˆ¬åˆ°äº†å¦ˆå¦ˆçš„ç™½èœé‡Œè¾¹ã€‚
å¤©é»‘äº†ï¼Œæœˆäº®æ¥äº†ï¼Œæ˜Ÿæ˜Ÿé—ªäº®ï¼Œé£å£°è¿‘äº†ï¼Œåæ¥èƒ–å¨ƒå¨ƒç¬‘ç€ç¡äº†ã€‚
å°å¨ƒå¨ƒçœ‹åˆ°é•œå­é‡Œæœ‰å¦ˆå¦ˆçš„ç¬‘è„¸ã€‚
å¥‡æ€ªï¼Œå¥‡æ€ªï¼Œå°å¨ƒå¨ƒå“­ç€å“­ç€å°±ç¬‘äº†ï¼
ä¸€é¢—çº¢è‘¡è„æ‰è¿›é›ªåœ°é‡Œï¼Œä¸€çœ¼å°±çœ‹åˆ°äº†ã€‚
æˆ‘å®¶æ¯”ä½ å®¶å»ç”°é‡Œè¿‘ï¼Œä»–å®¶æ¯”ä½ å®¶å»ç”°é‡Œè¿œã€‚
ç»†ç»†çš„çº¢çº¿å¼¯æˆäº†ä¸€æœµå°å°çš„æ¡ƒèŠ±ã€‚
æˆ‘é•¿å¤§äº†ä¼šæœ‰ä¸€åŒ¹å°çº¢é©¬ã€‚
çˆ¸çˆ¸çš„ç”»ä¸Šæœ‰äº‘ï¼Œæœ‰å±±ï¼Œæœ‰æ°´ï¼Œæœ‰æ ‘ï¼Œæœ‰é±¼ï¼Œæœ‰é¸Ÿï¼Œè¿˜æœ‰ä¹æœµèŠ±ã€‚
æˆ‘ååœ¨è‰åœ°ä¸Šï¼Œçœ‹è§è¿œè¿œçš„åœ°é‡Œæœ‰ä¸€ç¾¤å°ç™½ç¾Šã€ä¸€ç¾¤å°é»„é¸­å­ï¼Œä¸­é—´è¿˜æœ‰ä¸€å¤´å¤§é»‘ç‰›ã€‚`;}

function defaultSentencesEN(){return ``;}

function loadSentences(){
  const saved=localStorage.getItem('read_star_sents_'+appLang);
  const text=saved || (appLang==='en'?defaultSentencesEN():defaultSentencesZH());
  pool=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  $('sentencesArea').value=text;
}
function saveSentences(){ localStorage.setItem('read_star_sents_'+appLang, $('sentencesArea').value); }
loadSentences();

// --- Parent quick reset: force defaults for current language ---
const btnResetZH = $('btnResetZH');
const btnClearEN = $('btnClearEN');
const btnClearZH = $('btnClearZH');
if (btnResetZH) btnResetZH.addEventListener('click', ()=>{
  // Reset Chinese list; reflect in editor if current selected language is Chinese
  const curLang = (document.getElementById('langSel')?.value) || appLang;
  localStorage.removeItem('read_star_sents_zh');
  if (curLang === 'zh') {
    $('sentencesArea').value = defaultSentencesZH();
    saveSentences();
    loadSentences();
  }
  alert('å·²æ¢å¤åˆ°ä¸­æ–‡é»˜è®¤30å¥ã€‚');
});
if (btnClearZH) btnClearZH.addEventListener('click', ()=>{
  // Reset English list; reflect in editor if current selected language is English
  const curLang = (document.getElementById('langSel')?.value) || appLang;
  localStorage.removeItem('read_star_sents_zh');
  if (curLang === 'zh') {
    $('sentencesArea').value = ``;
    saveSentences();
  }
  alert('ä¸­æ–‡åˆ—è¡¨å·²æ¸…ç©ºã€‚');
});
if (btnClearEN) btnClearEN.addEventListener('click', ()=>{
  // Reset English list; reflect in editor if current selected language is English
  const curLang = (document.getElementById('langSel')?.value) || appLang;
  localStorage.removeItem('read_star_sents_en');
  if (curLang === 'en') {
    $('sentencesArea').value = ``;
    saveSentences();
  }
  alert('è‹±æ–‡åˆ—è¡¨å·²æ¸…ç©ºã€‚');
});
                

/* ---------- Dice + next sentence (2s) ---------- */
function rollDice(cb){
  const d=$('dice'); d.classList.add('rolling'); d.style.opacity=1;
  setTimeout(()=>{ d.classList.remove('rolling'); d.style.opacity=0; cb&&cb(); }, 2000);
}
function nextSentence(){
  loadSentences();
  if(pool.length===0){alert(appLang==='en'?'Please add sentences first':'è¯·å…ˆæ·»åŠ å¥å­');return;}
  rollDice(()=>{
    target=pool[Math.floor(Math.random()*pool.length)];
    textOr('sentenceText', target);
    textOr('sentenceTip', appLang==='en'?'Tap Start to read aloud':'è¯·ç‚¹å¼€å§‹æœ—è¯»');
    $('status').textContent=(appLang==='en'?'Tap Start to read aloud':'è¯·ç‚¹å¼€å§‹æœ—è¯»');
    $('heard').textContent='';$('bigstar').textContent='';
    $('meter').style.width='0%';
    $('btnListen').disabled=false;$('btnStop').disabled=true;$('btnRetry').disabled=true;
  });
}
$('btnNext').addEventListener('click', nextSentence);
$('btnShow').addEventListener('click', ()=>{if(target) alert(target);});

/* ---------- Speech ---------- */
let recognition,listening=false;
function initReco(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert(appLang==='en'?'Browser does not support speech recognition.':'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');return null;}
  const r=new SR();
  r.lang = (appLang==='en'?'en-US':'zh-CN');
  r.interimResults=true; r.continuous=true;
  return r;
}
$('btnListen').addEventListener('click', ()=>{
  if(!target){nextSentence();return;}
  recognition=initReco(); if(!recognition) return;
  const kidName = ( $('kidName') ? ($('kidName').value||'kalie').trim() : 'kalie') || 'kalie';
  $('status').textContent=(appLang==='en'?'Listeningâ€¦':'æ­£åœ¨å¬â€¦â€¦');
  $('btnListen').disabled=true;$('btnStop').disabled=false;$('btnRetry').disabled=true;
  listening=true;
  recognition.onresult=(e)=>{
    let buf=''; for(let i=e.resultIndex;i<e.results.length;i++){buf+=e.results[i][0].transcript;}
    $('heard').textContent=buf;
    const sim=similarity(buf,target); $('meter').style.width=Math.round(sim*100)+'%';
  };
  recognition.onend=()=>{listening=false;};
  recognition.start();
});

$('btnStop').addEventListener('click', ()=>{
  if(recognition) recognition.stop();
  listening=false;
  $('btnStop').disabled=true;$('btnListen').disabled=false;$('btnRetry').disabled=false;
  const heard=$('heard').textContent.trim();
  if(!heard){$('status').textContent=(appLang==='en'?'No voice detected':'æœªè¯†åˆ«åˆ°è¯­éŸ³');return;}
  const sim=similarity(heard,target);
  const th = Number(($('thres')||{value:85}).value)/100;
  const step = Number(($('rewardStep')||{value:5}).value);
  const pass=sim>=th;
  const kidName = ( $('kidName') ? ($('kidName').value||'Kalie').trim() : 'Kalie') || 'Kalie';
  if(pass){
    stars+=1; localStorage.setItem('read_star_stars',String(stars)); $('starsCount').textContent=stars;
    $('bigstar').innerHTML="<span class='ok'>â­ Awesome!</span>";
    $('status').textContent=(appLang==='en'
      ?`Done. Similarity: ${Math.round(sim*100)}%, Threshold: ${Math.round(th*100)}%`
      :`åˆ¤å®šå®Œæˆï¼ˆç›¸ä¼¼åº¦ï¼š${Math.round(sim*100)}%ï¼Œé˜ˆå€¼ï¼š${Math.round(th*100)}%ï¼‰`);
    speakEN(pick(PASS_EN)(kidName));
    if(stars % step === 0){ openReward(); }
  }else{
    $('bigstar').textContent='Try again~';
    $('status').textContent=(appLang==='en'
      ?`Not passed. Similarity: ${Math.round(sim*100)}%, Threshold: ${Math.round(th*100)}%`
      :`æœªé€šè¿‡ï¼ˆç›¸ä¼¼åº¦ï¼š${Math.round(sim*100)}%ï¼Œé˜ˆå€¼ï¼š${Math.round(th*100)}%ï¼‰ã€‚å¯ä»¥ç‚¹â€œé‡è¯•æœ¬å¥â€ã€‚`);
    speakEN(pick(FAIL_EN)(kidName));
  }
});

$('btnRetry').addEventListener('click', ()=>{
  $('heard').textContent='';$('meter').style.width='0%';$('bigstar').textContent='';$('btnListen').click();
});

$('btnReset').addEventListener('click', ()=>{
  if(confirm(appLang==='en'?'Reset stars to 0?':'æ¸…ç©ºæ˜Ÿæ˜Ÿï¼Ÿ')){
    stars=0; localStorage.setItem('read_star_stars','0'); $('starsCount').textContent=0;
  }
});

/* ---------- Images (external & local + manifest) ---------- */
const IMG_LIST_KEY='read_star_reward_images';
let rewardImages=[],rewardIdx=Number(localStorage.getItem('read_star_reward_index')||0);
function renderImgListGeneric(ulId){
  const ul=$(ulId); ul.innerHTML='';
  if(rewardImages.length===0){const li=document.createElement('li'); li.textContent=(appLang==='en'?'No images yet. Use parent settings to add.':'å°šæœªæ·»åŠ å›¾ç‰‡ã€‚è¯·åœ¨å®¶é•¿è®¾ç½®ä¸­æ·»åŠ ã€‚'); ul.appendChild(li); return;}
  rewardImages.forEach((src,i)=>{
    const li=document.createElement('li'); const img=new Image(); img.src=src; img.className='thumb';
    const del=document.createElement('button'); del.textContent=(appLang==='en'?'Delete':'åˆ é™¤'); del.className='secondary'; del.onclick=()=>{rewardImages.splice(i,1); saveImages();};
    const span=document.createElement('span'); span.textContent=src.slice(0,60)+(src.length>60?'â€¦':'');
    li.appendChild(img); li.appendChild(span); li.appendChild(del); ul.appendChild(li);
  });
}
function renderImgList(){ renderImgListGeneric('imgList'); renderImgListGeneric('imgListParent'); }
function loadImages(){
  try{rewardImages=JSON.parse(localStorage.getItem(IMG_LIST_KEY)||'[]');}catch(e){rewardImages=[];}
  renderImgList();
}
function saveImages(){ localStorage.setItem(IMG_LIST_KEY,JSON.stringify(rewardImages)); renderImgList(); }
$('btnAddUrl').addEventListener('click', ()=>{const url=$('imgUrl').value.trim(); if(!url) return; rewardImages.push(url); $('imgUrl').value=''; saveImages();});
$('btnAddFile').addEventListener('click', ()=>{
  const f=$('imgFile').files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>{rewardImages.push(reader.result); saveImages(); $('imgFile').value='';}; reader.readAsDataURL(f);
});
$('btnLoadManifest').addEventListener('click', async ()=>{
  async function tryJson(){ try{ const res=await fetch('reward_images.json',{cache:'no-store'}); if(!res.ok) return false; const arr=await res.json(); if(Array.isArray(arr)){ arr.forEach(p=>{ if(typeof p==='string'){ rewardImages.push(p); } }); saveImages(); return true; } }catch(e){} return false; }
  async function tryTxt(){ try{ const res=await fetch('reward_images.txt',{cache:'no-store'}); if(!res.ok) return false; const txt=await res.text(); txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(p=>rewardImages.push(p)); saveImages(); return true; }catch(e){} return false; }
  const ok = await tryJson() || await tryTxt();
  if(!ok) alert(appLang==='en'?'Manifest not found or invalid.':'æœªæ‰¾åˆ°æ¸…å•æ–‡ä»¶æˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚');
});
loadImages();

/* ---------- Reward modal with gallery, undo, wheel/pinch zoom ---------- */
function openReward(){ if(rewardImages.length===0){alert(appLang==='en'?'No images yet.':'è¿˜æ²¡æœ‰æ·»åŠ å¥–åŠ±å›¾ç‰‡');return;} showReward(); }
$('btnColorNow').addEventListener('click', openReward);

function showReward(){
  const modal=$('rewardModal'); modal.style.display='flex'; modal.style.zIndex=110; modal.setAttribute('aria-hidden','false');
  const view=$('view'); const vctx=view.getContext('2d');
  const base=document.createElement('canvas'); base.width=1400; base.height=1050; const bctx=base.getContext('2d');
  const img=new Image(); img.crossOrigin='anonymous';
  const corsWarn=$('corsWarn'); corsWarn.style.display='none';

  // state
  let curColor='#ff7f00';
  let mode='bucket';
  let zoom=1, panX=0, panY=0;
  let drawing=false, last=null;

  // Undo stack
  const undoStack=[];
  function snapshot(){ try{ undoStack.push(bctx.getImageData(0,0,base.width,base.height)); if(undoStack.length>20) undoStack.shift(); }catch(e){} }
  function undo(){ if(undoStack.length){ const lastSnap=undoStack.pop(); bctx.putImageData(lastSnap,0,0); drawView(); } }
  $('undoBtn').onclick=undo;

  // UI init
  const brush=$('brush'), brushSize=$('brushSize'); brush.oninput=()=>brushSize.textContent=brush.value; brush.dispatchEvent(new Event('input'));
  const tol=$('tol'), tolVal=$('tolVal'); tol.oninput=()=>tolVal.textContent=tol.value; tol.dispatchEvent(new Event('input'));
  const colors=['#000000','#3e2723','#795548','#9e9e9e','#ffffff','#ff1744','#ff8a80','#ff6d00','#ffeb3b','#cddc39','#00c853','#4caf50','#00bcd4','#2196f3','#3f51b5','#9c27b0','#e91e63'];
  const palette=$('palette'); palette.innerHTML=''; colors.forEach(c=>{const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c; sw.title=c; sw.onclick=()=>{curColor=c;}; palette.appendChild(sw);});
  function setMode(m){
    mode=m;
    ['toolPaint','toolBucket','toolPan'].forEach(id=>$(id).classList.remove('on'));
    if(m==='paint') $('toolPaint').classList.add('on');
    if(m==='bucket') $('toolBucket').classList.add('on');
    if(m==='pan') $('toolPan').classList.add('on');
  }
  $('toolPaint').onclick=()=>setMode('paint'); $('toolBucket').onclick=()=>setMode('bucket'); $('toolPan').onclick=()=>setMode('pan');
  $('zoom').oninput=(e)=>{zoom=Number(e.target.value)/100; drawView();};
  $('zoomIn').onclick=()=>{const z=Math.min(200, Number($('zoom').value)+10); $('zoom').value=z; zoom=z/100; drawView();};
  $('zoomOut').onclick=()=>{const z=Math.max(50, Number($('zoom').value)-10); $('zoom').value=z; zoom=z/100; drawView();};
  $('fit').onclick=()=>{$('zoom').value=100; zoom=1; panX=0; panY=0; drawView();};

  // Gallery
  const gallery=$('gallery');
  function buildGallery(activeIndex){
    gallery.innerHTML='';
    rewardImages.forEach((src,i)=>{
      const cell=document.createElement('div');
      cell.className='gitem'+(i===activeIndex?' active':'');
      const im=document.createElement('img'); im.src=src;
      cell.appendChild(im);
      cell.onclick=()=>{ rewardIdx=i; localStorage.setItem('read_star_reward_index',String(rewardIdx)); loadImage(i); buildGallery(i); };
      gallery.appendChild(cell);
    });
  }

  // Transforms
  function viewToBase(x,y){
    const dx=(view.width - base.width*zoom)/2 + panX;
    const dy=(view.height - base.height*zoom)/2 + panY;
    return {x: (x - dx)/zoom, y: (y - dy)/zoom};
  }
  function baseToView(x,y){
    const dx=(view.width - base.width*zoom)/2 + panX;
    const dy=(view.height - base.height*zoom)/2 + panY;
    return {x: dx + x*zoom, y: dy + y*zoom};
  }
  function drawView(){
    vctx.clearRect(0,0,view.width,view.height);
    const dw=base.width*zoom, dh=base.height*zoom;
    const dx=(view.width - dw)/2 + panX, dy=(view.height - dh)/2 + panY;
    vctx.imageSmoothingEnabled=true; vctx.imageSmoothingQuality='high';
    vctx.drawImage(base, dx, dy, dw, dh);
  }
  function clearToImage(){
    bctx.fillStyle='#ffffff'; bctx.fillRect(0,0,base.width,base.height);
    const iw=img.width, ih=img.height, bw=base.width, bh=base.height;
    const scale=Math.min(bw/iw, bh/ih);
    const dw=iw*scale, dh=ih*scale;
    const dx=(bw-dw)/2, dy=(bh-dh)/2;
    bctx.drawImage(img, dx, dy, dw, dh);
  }

  // Helpers for input
  function getPos(e){
    const r=view.getBoundingClientRect();
    const vx = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const vy = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    const sx = vx * view.width/r.width, sy = vy * view.height/r.height;
    return viewToBase(sx, sy);
  }

  // Drawing handlers
  function start(e){
    drawing=true; last=getPos(e);
    if(mode==='paint'){ snapshot(); bctx.beginPath(); bctx.moveTo(last.x,last.y); }
    e.preventDefault();
  }
  function move(e){
    if(!drawing) return;
    const p=getPos(e);
    if(mode==='paint'){
      bctx.lineWidth=Number($('brush').value);
      bctx.lineCap='round'; bctx.lineJoin='round';
      bctx.strokeStyle=curColor; bctx.globalAlpha=1;
      bctx.lineTo(p.x,p.y); bctx.stroke();
      drawView();
    }else if(mode==='pan'){
      const r=view.getBoundingClientRect();
      const vx = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
      const vy = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
      const prev = {x:(last.x*zoom + (view.width - base.width*zoom)/2 + panX)*r.width/view.width,
                    y:(last.y*zoom + (view.height - base.height*zoom)/2 + panY)*r.height/view.height};
      panX += (vx - prev.x); panY += (vy - prev.y);
      last = getPos(e);
      drawView();
    }
    e.preventDefault();
  }
  function end(){ drawing=false; }

  // Bucket fill
  function colorAt(data, x, y, w){const i=(y*w + x)*4; return [data[i],data[i+1],data[i+2],data[i+3]];}
  function colorEq(a,b, tol){return Math.abs(a[0]-b[0])<=tol && Math.abs(a[1]-b[1])<=tol && Math.abs(a[2]-b[2])<=tol && Math.abs(a[3]-b[3])<=tol;}
  function setColor(data, x, y, w, col){const i=(y*w + x)*4; data[i]=col[0]; data[i+1]=col[1]; data[i+2]=col[2]; data[i+3]=255;}
  function hexToRgba(hex){const c=hex.replace('#',''); const bigint=parseInt(c,16);
    if(c.length===3){const r=(bigint>>8)&0xf; const g=(bigint>>4)&0xf; const b=bigint&0xf; return [r*17,g*17,b*17,255];}
    return [(bigint>>16)&255,(bigint>>8)&255,bigint&255,255];
  }
  function bucketFill(sx,sy,hex,tolerance){
    sx=Math.floor(sx); sy=Math.floor(sy);
    if(sx<0||sy<0||sx>=base.width||sy>=base.height) return;
    snapshot();
    const imgData=bctx.getImageData(0,0,base.width,base.height);
    const data=imgData.data, w=imgData.width, h=imgData.height;
    const target=colorAt(data,sx,sy,w);
    const fillColor=hexToRgba(hex);
    if(colorEq(target, fillColor, 0)) return;
    const stack=[[sx,sy]]; const visited=new Uint8Array(w*h);
    const tol=Number(tolerance);
    while(stack.length){
      const [x,y]=stack.pop();
      if(x<0||y<0||x>=w||y>=h) continue;
      const idx=y*w+x; if(visited[idx]) continue;
      const cur=colorAt(data,x,y,w);
      if(!colorEq(cur,target,tol)) continue;
      visited[idx]=1; setColor(data,x,y,w,fillColor);
      stack.push([x+1,y]); stack.push([x-1,y]); stack.push([x,y+1]); stack.push([x,y-1]);
    }
    bctx.putImageData(imgData,0,0);
    drawView();
  }

  // Bind interactions
  view.oncontextmenu = (e)=>{ e.preventDefault(); undo(); };
  view.onmousedown = (e)=>{ if(e.button===2){return;} if(mode==='bucket'){ const p=getPos(e); bucketFill(p.x,p.y,curColor,$('tol').value); } else { start(e); } };
  view.onmousemove = move; window.onmouseup = end;
  view.ontouchstart = (e)=>{ if(e.touches.length===1){ if(mode==='bucket'){ const p=getPos(e); bucketFill(p.x,p.y,curColor,$('tol').value); } else { start(e); } } };
  view.ontouchmove = move; window.ontouchend = end;

  // Wheel zoom
  view.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const delta = e.deltaY < 0 ? 1.1 : 0.9;
    const r=view.getBoundingClientRect();
    const cx=(e.clientX - r.left) * view.width/r.width;
    const cy=(e.clientY - r.top) * view.height/r.height;
    const world = viewToBase(cx, cy);
    const newZoom = Math.min(2.0, Math.max(0.5, zoom * delta));
    if(newZoom === zoom) return;
    const before = baseToView(world.x, world.y);
    zoom = newZoom; $('zoom').value = Math.round(zoom*100);
    const after = baseToView(world.x, world.y);
    panX += (cx - after.x);
    panY += (cy - after.y);
    drawView();
  }, {passive:false});

  // Pinch zoom
  let pinchStartDist = 0, pinchStartZoom = 1, pinchStartMid = null;
  function distance(t1,t2){ const dx=t1.clientX - t2.clientX, dy=t1.clientY - t2.clientY; return Math.hypot(dx,dy); }
  function midpoint(t1,t2){ return {x:(t1.clientX+t2.clientX)/2, y:(t1.clientY+t2.clientY)/2}; }
  view.addEventListener('touchstart', (e)=>{
    if(e.touches.length===2){
      pinchStartDist = distance(e.touches[0], e.touches[1]);
      pinchStartZoom = zoom;
      const r=view.getBoundingClientRect();
      const mid = midpoint(e.touches[0], e.touches[1]);
      const cx=(mid.x - r.left) * view.width/r.width;
      const cy=(mid.y - r.top) * view.height/r.height;
      pinchStartMid = {cx, cy, world: viewToBase(cx, cy)};
    }
  }, {passive:false});
  view.addEventListener('touchmove', (e)=>{
    if(e.touches.length===2 && pinchStartDist>0){
      e.preventDefault();
      const dist = distance(e.touches[0], e.touches[1]);
      const scale = dist / pinchStartDist;
      zoom = Math.min(2.0, Math.max(0.5, pinchStartZoom * scale));
      $('zoom').value = Math.round(zoom*100);
      const after = baseToView(pinchStartMid.world.x, pinchStartMid.world.y);
      panX += (pinchStartMid.cx - after.x);
      panY += (pinchStartMid.cy - after.y);
      drawView();
    }
  }, {passive:false});
  view.addEventListener('touchend', (e)=>{
    if(e.touches.length<2){ pinchStartDist=0; pinchStartMid=null; }
  });

  // Commands
  $('btnClear').onclick=()=>{ snapshot(); clearToImage(); drawView(); };
  $('btnSaveImg').onclick=()=>{
    try{ const a=document.createElement('a'); a.href=base.toDataURL('image/png'); a.download='coloring.png'; a.click(); }
    catch(err){ corsWarn.style.display='block'; alert(appLang==='en'?'Cross-origin blocked. Use local upload for saving.':'å›¾ç‰‡æºæœªå…è®¸è·¨åŸŸï¼Œæ— æ³•ä¿å­˜ PNGã€‚å»ºè®®ä¸Šä¼ æœ¬åœ°å›¾ç‰‡æˆ–ä½¿ç”¨åŒåŸŸ/å…è®¸ CORS çš„å›¾ç‰‡åœ°å€ã€‚'); }
  };
  $('btnClose').onclick=()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };

  function loadImage(i){
    const src=rewardImages[i % rewardImages.length];
    img.onload=()=>{ clearToImage(); undoStack.length=0; drawView(); setMode('bucket'); };
    img.onerror=()=>{ corsWarn.style.display='block'; bctx.fillStyle='#fff'; bctx.fillRect(0,0,base.width,base.height); undoStack.length=0; drawView(); setMode('bucket'); };
    img.src=src;
    $('zoom').value=100; zoom=1; panX=0; panY=0;
  }
  function buildAndLoad(){
    const active=rewardIdx % rewardImages.length;
    buildGallery(active);
    loadImage(active);
  }
  buildAndLoad();
}

/* ---------- Parent-only: edit sentences visibility ---------- */
$('btnEditSentences').addEventListener('click', ()=>{
  const ta=$('sentencesArea');
  ta.style.display = (ta.style.display==='none'?'block':'none');
});
$('btnCloseParent').addEventListener('click', ()=>{ saveSentences(); parentModal.style.display='none'; });

/* ---------- i18n apply ---------- */
function applyI18n(){
  const m = I18N[appLang];
  textOr('btnResetZH', m.btnResetZH);
  textOr('btnClearEN', m.btnClearEN);
  textOr('btnClearZH', m.btnClearZH);
  textOr('titleH1', m.title);
  textOr('langLabel', m.langLabel);
  textOr('parentBtnText', m.parentBtn);
  textOr('scoreLabel', m.scoreLabel);
  textOr('recHint', m.recHint);
  textOr('browserHint', m.browserHint);
  textOr('rewardHint', m.rewardHint);
  textOr('sentenceTip', m.sentenceTip);
  textOr('btnNext', m.btnNext);
  textOr('btnListen', m.btnListen);
  textOr('btnStop', m.btnStop);
  textOr('btnRetry', m.btnRetry);
  textOr('btnShow', m.btnShow);
  textOr('btnColorNow', m.btnColorNow);
  textOr('btnReset', m.btnReset);
  textOr('sentencesSummary', m.sentencesSummary);
  textOr('sentencesHint', m.sentencesHint);
  textOr('imagesSummary', m.imagesSummary);
  textOr('imagesHint', m.imagesHint);
  textOr('parentTitle', m.parentTitle);
  textOr('pinLabel', m.pinLabel);
  textOr('pinOk', m.pinOk);
  textOr('pinCancel', m.pinCancel);
  textOr('thresLabel', m.thresLabel);
  textOr('btnThresReset', m.btnThresReset);
  textOr('rewardStepLabel', m.rewardStepLabel);
  textOr('btnRewardReset', m.btnRewardReset);
  textOr('kidNameLabel', m.kidNameLabel);
  textOr('btnSaveKid', m.btnSaveKid);
  textOr('langSelLabel', m.langSelLabel);
  textOr('langHint', m.langHint);
  textOr('manifestHint', m.manifestHint);
  textOr('btnAddUrl', m.btnAddUrl);
  textOr('btnAddFile', m.btnAddFile);
  textOr('btnLoadManifest', m.btnLoadManifest);
  textOr('btnEditSentences', m.btnEditSentences);
  textOr('btnCloseParent', m.btnCloseParent);
  textOr('rewardTitle', m.rewardTitle);
  textOr('brushLabel', m.brushLabel);
  textOr('tolLabel', m.tolLabel);
  textOr('viewLabel', m.viewLabel);
  textOr('fit', m.fit);
  textOr('toolPaint', m.toolPaint);
  textOr('toolBucket', m.toolBucket);
  textOr('toolPan', m.toolPan);
  textOr('undoBtn', m.undoBtn);
  textOr('btnClear', m.btnClear);
  textOr('btnSaveImg', m.btnSaveImg);
  textOr('btnClose', m.btnClose);
  textOr('corsWarn', m.corsWarn);
  textOr('rewardUnit', m.rewardUnit);
  textOr('langShow', (appLang==='en'?'English':'ä¸­æ–‡'));
  document.documentElement.lang = (appLang==='en'?'en':'zh-CN');
}
applyI18n();
</script>
</body>
</html>
